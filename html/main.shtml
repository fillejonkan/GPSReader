<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible"/>
<title>AXIS GPS Receiver</title>

<script src="jquery-1.10.2.js"></script>
<script src="jquery.ui.core.js"></script>
<script src="jquery.ui.widget.js"></script>
<script src="jquery.ui.tabs.js"></script>
<script src="camera_services.1.0.0.js"></script>
<link href="css/cupertino/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">

<script>

var APP_ID = "gpsrecv";

$(function() {  //jQuery UI TAB initialize
  $( "#tabs" ).tabs();
  // Hover states on the static widgets
  $( "#dialog-link, #icons li" ).hover(
    function() {
      $( this ).addClass( "ui-state-hover" );
    },
    function() {
      $( this ).removeClass( "ui-state-hover" );
    }
  );
});

$(document).ready( function() {

  requestApplicationSettings();
  loadApplicationLog(APP_ID, printLog ); //camera_services.1.0.0.js
  loadEventDeclarations( printEventDeclaration ); //camera_services.1.0.0.js 

  //Update the application parameters when user change
  
  $( "#LogInterval" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#LogInterval" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=LogInterval&value=" + $( "#LogInterval" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });
  
  $( "#LogCount" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#LogCount" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=LogCount&value=" + $( "#LogCount" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#ApiKey" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#ApiKey" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=ApiKey&value=" + $( "#ApiKey" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#UDPPort" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#UDPPort" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=UDPPort&value=" + $( "#UDPPort" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#EXIFInt" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#EXIFInt" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=EXIFInt&value=" + $( "#EXIFInt" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#FTPUser" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#FTPUser" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=FTPUser&value=" + $( "#FTPUser" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#FTPPass" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#FTPPass" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=FTPPass&value=" + $( "#FTPPass" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#FTPServer" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#FTPServer" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=FTPServer&value=" + $( "#FTPServer" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#FTPFolder" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#FTPFolder" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=FTPFolder&value=" + $( "#FTPFolder" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  $( "#FTPBaseName" ).keypress( function (eventObject) {
    var key = eventObject.keyCode || eventObject.charCode;
    if( key == 13 ){
      $( "#FTPBaseName" ).blur();
      eventObject.preventDefault();
      $.ajax({ type: "GET", url: "settings/set?param=FTPBaseName&value=" + $( "#FTPBaseName" ).val(), dataType: "xml",cache: false, success: checkErrorMessage, error: noResponseError});
    }
  });

  //Update log on refresh
  $( "#refresh_log" ).click(function(){loadApplicationLog(APP_ID, printLog);});
/*  
  //Initiate map
  var myOptions = {
    zoom: 6,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  
  var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

  var geoXml = new geoXML3.parser({
    map: map,
    singleInfoWindow: true
  });

  geoXml.parse('gps/history');
*/
});

function requestApplicationSettings()
{
  $.ajax({
    type: "GET",
    url: "settings/get",
    dataType: "xml",
    cache: false,
    success: function( responseData ){
      if( checkErrorMessage( responseData ) )
        return;
      var Parameters = $(responseData).find("param");
      /*var param;
      for(param in Parameters)
        $("#"+param.getAttribute("name")).val( param.getAttribute("value") );
      */
      $("#LogInterval").val( Parameters[0].getAttribute("value") );
      $("#LogCount").val( Parameters[1].getAttribute("value") );
      $("#ApiKey").val( Parameters[2].getAttribute("value") );
      $("#UDPPort").val( Parameters[3].getAttribute("value") );
      $("#EXIFInt").val( Parameters[4].getAttribute("value") );
      $("#FTPUser").val( Parameters[5].getAttribute("value") );
      $("#FTPPass").val( Parameters[6].getAttribute("value") );
      $("#FTPServer").val( Parameters[7].getAttribute("value") );
      $("#FTPFolder").val( Parameters[8].getAttribute("value") );
      $("#FTPBaseName").val( Parameters[9].getAttribute("value") );

      var apikey = $("#ApiKey").val();
      var source = "./map.html#" + apikey;
      document.getElementById("iframe_gps").src = source;
    },
    error: noResponseError
  });
}

//Check if the application replies an error e.g. <error description="Some description"/>
//Returns TRUE if an error response is detected
function checkErrorMessage( responseData )
{
  var errors = $(responseData).find("error");  //Error message from the application
  if( errors.length ) {
    alert( errors[0].getAttribute("description") ); //Alert only the first message
    return true;
  }
  return false;
}

//The application does not respond at all
function noResponseError()
{
  alert("No response from application.\n\nCheck if the application is running.");
}

function printEventDeclaration( xmlData )
{
  var applicationEvents = xmlSubSection( xmlData, APP_ID );  //Show only the events for the application
  var formatedXML = prettyXML( applicationEvents ); //camera_services.1.0.0.js
  $("#textarea_event_declarations").val( formatedXML );
}

function printLog( text )
{
  var formatedLog = prettyLOG( text );  //camera_services.1.0.0.js
  $("#textarea_log").val( formatedLog );
}
</script>

</head>

<body>
  <div id="tabs">
    <ul>
      <li><a href="#tabs-1">Parameters</a></li>
      <li><a href="#tabs-2">Map</a></li>
      <li><a href="#tabs-3">LOG</a></li>
    </ul>
    <div id="tabs-1">
      <h2>Application parameters</h2>
      <table>
        <tr>
          <td>Log Interval</td>
          <td><input id="LogInterval"></td>
        </tr>
        <tr>
          <td>Log Count</td>
          <td><input id="LogCount"></td>
        </tr>
        <tr>
          <td>Google Maps API Key</td>
          <td><input id="ApiKey"></td>
        </tr>
        <tr>
          <td>UDP Port</td>
          <td><input id="UDPPort"></td>
        </tr>
        <tr>
          <td>EXIF Upload Interval</td>
          <td><input id="EXIFInt"></td>
        </tr>
        <tr>
          <td>FTP Username</td>
          <td><input id="FTPUser"></td>
        </tr>
        <tr>
          <td>FTP password</td>
          <td><input id="FTPPass" type="password"></td>
        </tr>
        <tr>
          <td>FTP Server Address</td>
          <td><input id="FTPServer"></td>
        </tr>
        <tr>
          <td>FTP Folder Path</td>
          <td><input id="FTPFolder"></td>
        </tr>
        <tr>
          <td>FTP Base File Name</td>
          <td><input id="FTPBaseName"></td>
        </tr>
      </table>
      <br/>
      <a href="../../axis-cgi/param.cgi?action=list" target="_blank">View the cameras parameter list</a>
    </div>
    <div id="tabs-2">
      <iframe height="600" width="100%" src="" id="iframe_gps"></iframe>
    </div>
    <div id="tabs-3">
      <h2>Application log</h2>
      <button id="refresh_log">Refresh</button>
      <br/>
      <textarea id="textarea_log" rows="10" cols="100"></textarea>
    </div>
  </div>
</body>

</html>


